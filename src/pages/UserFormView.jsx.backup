
import React, { useState, useEffect, useMemo, useCallback, memo } from 'react';
import { Helmet } from 'react-helmet';
import { motion, AnimatePresence } from 'framer-motion';
import { useParams, useNavigate } from 'react-router-dom';
import { 
  Sparkles, ArrowRight, User, GraduationCap, Gift, ChevronDown,
  // Import icons untuk section preview
  Mail, Phone, MapPin, CreditCard, FileText, Calendar, 
  Briefcase, Heart, Home, Settings, Star, ShoppingCart,
  // Import icons untuk upsell
  Zap, TrendingUp, Award, CheckCircle2, Crown
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useToast } from '@/components/ui/use-toast';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import api from '@/lib/api';

// Icon mapping untuk section (sama dengan FormBuilderEditor)
const SECTION_ICONS = {
  User, Mail, Phone, MapPin, CreditCard, FileText, Calendar,
  Briefcase, GraduationCap, Heart, Home, Settings, Star, ShoppingCart
};

// Helper function untuk format rupiah (tampilan saja, tanpa Rp)
const formatRupiah = (number) => {
  return new Intl.NumberFormat('id-ID').format(number);
};

// Memoized field component to prevent unnecessary re-renders
const FormField = memo(({ field, value, onChange }) => {
  const commonProps = {
    id: `field-${field.id}`,
    required: field.required,
    placeholder: field.placeholder,
    value: value || '',
    onChange: onChange,
    className: "mt-1"
  };

  const renderFieldInput = () => {
    switch (field.type) {
      case 'textarea':
        return <textarea {...commonProps} className="flex min-h-[80px] w-full rounded-xl border border-input bg-background px-3 py-2 text-sm mt-1" />;
      case 'select':
        return (
          <Select value={value || ''} onValueChange={(val) => onChange({ target: { value: val } })}>
            <SelectTrigger className="mt-1">
              <SelectValue placeholder={field.placeholder || "Pilih salah satu"} />
            </SelectTrigger>
            <SelectContent>
              {(field.options || '').split(',').map(opt => opt.trim()).filter(Boolean).map(option => (
                <SelectItem key={option} value={option}>{option}</SelectItem>
              ))}
            </SelectContent>
          </Select>
        );
      default:
        return <Input type={field.type} {...commonProps} />;
    }
  };

  return (
    <div>
      <Label htmlFor={`field-${field.id}`}>
        {field.label}
        {field.required && <span className="text-red-500 ml-1">*</span>}
      </Label>
      {renderFieldInput()}
    </div>
  );
});

FormField.displayName = 'FormField';

const UserFormView = ({ isPreview = false, previewData = null }) => {
  const { formSlug } = useParams(); // Changed from formId to formSlug
  const navigate = useNavigate();
  const { toast } = useToast();
  const [formData, setFormData] = useState(null);
  const [selectedTier, setSelectedTier] = useState(null);
  const [showUpsell, setShowUpsell] = useState(false);
  const [formValues, setFormValues] = useState({});
  const [affiliateCode, setAffiliateCode] = useState('');
  const [currentSectionId, setCurrentSectionId] = useState(null);
  const [isExpiredPreview, setIsExpiredPreview] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isLoading, setIsLoading] = useState(true); // Set true by default

  // Check for affiliate code in URL parameter
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref') || urlParams.get('affiliate') || urlParams.get('aff');
    if (refCode) {
      setAffiliateCode(refCode.toUpperCase());
      console.log('ðŸŽ Affiliate code detected from URL:', refCode);
    }
  }, []);

  // Optimize: Only update formData when necessary
  useEffect(() => {
    const loadForm = async () => {
      if (isPreview && previewData) {
        setFormData(previewData);
        setIsLoading(false); // No loading for preview mode
      } else if (!isPreview && formSlug) {
        setIsLoading(true);
        try {
          // Try to load from API first (public endpoint using slug, without /view)
          const response = await api.publicGet(`public/forms/${formSlug}`);
          
          // Transform backend data to match frontend structure
          const backendData = response.data;
          const transformedData = {
            id: backendData.id,
            title: backendData.title,
            description: backendData.description || '',
            coverImage: backendData.cover_image || '',
            folder: backendData.category?.name || 'Uncategorized',
            sections: backendData.sections?.map(section => ({
              id: section.id || `section_${Date.now()}_${Math.random()}`,
              name: section.title,
              icon: section.icon || 'FileText'
            })) || [],
            fields: backendData.sections?.flatMap(section => 
              section.fields?.map(field => ({
                id: field.id || `field_${Date.now()}_${Math.random()}`,
                label: field.label,
                type: field.type === 'phone' ? 'tel' : field.type, // Map phone back to tel
                required: field.is_required || false,
                placeholder: field.placeholder || '',
                options: field.options?.map(opt => opt.label).join(', ') || '',
                sectionId: section.id
              })) || []
            ) || [],
            hasPayment: backendData.enable_payment || false,
            hasAffiliate: backendData.enable_affiliate || false,
            upsellEnabled: backendData.settings?.upsell_enabled || false,
            freeOption: backendData.settings?.free_option || false,
            pricingTiers: [
              // Always include free tier if enabled
              ...(backendData.settings?.free_option ? [{ 
                id: 0, 
                name: 'Gratis', 
                price: 0, 
                features: 'Akses dasar' 
              }] : []),
              // Add paid tiers from backend
              ...(backendData.pricing_tiers?.map(tier => ({
                id: tier.id,
                name: tier.name,
                price: parseInt(tier.price) || 0, // Convert to integer, remove decimal
                features: tier.description || tier.name
              })) || [])
            ],
            submissions: backendData.submissions_count || 0,
            createdAt: backendData.created_at
          };
          
          setFormData(transformedData);
          console.log('âœ… Form loaded by slug:', formSlug, transformedData);
        } catch (error) {
          console.error('Failed to load form from API:', error);
          // Fallback to localStorage (for backward compatibility or temp preview)
          const savedFormData = localStorage.getItem(`smartpath_form_${formSlug}`);
          if (savedFormData) {
            setFormData(JSON.parse(savedFormData));
            console.log('âœ… Form loaded from localStorage:', formSlug);
          } else if (formSlug.startsWith('temp_preview_')) {
            // Temp preview sudah dihapus atau expired
            setIsExpiredPreview(true);
          }
          
          // Note: Temp preview data will NOT be auto-deleted
          // User can manually close the tab or it will be cleaned on next preview creation
        } finally {
          setIsLoading(false);
        }
      }
    };
    
    loadForm();
  }, [formSlug, isPreview]); // Changed from formId to formSlug

  // Update form data separately when previewData changes (for preview mode only)
  useEffect(() => {
    if (isPreview && previewData) {
      setFormData(previewData);
    }
  }, [isPreview, previewData]);

  useEffect(() => {
    if (formData) {
      if (formData.sections && formData.sections.length > 0 && !currentSectionId) {
        setCurrentSectionId(formData.sections[0].id);
      }
      if (formData.hasPayment && formData.pricingTiers.length > 0 && !selectedTier) {
        const freeTier = formData.pricingTiers.find(t => t.price === 0);
        setSelectedTier(freeTier || formData.pricingTiers[0]);
      }
    }
  }, [formData, currentSectionId, selectedTier]);

  const handleSectionChange = useCallback((direction) => {
    setCurrentSectionId(prevId => {
      if (!formData || !formData.sections) return prevId;
      const currentIndex = formData.sections.findIndex(s => s.id === prevId);
      const nextIndex = currentIndex + direction;
      if (nextIndex >= 0 && nextIndex < formData.sections.length) {
        return formData.sections[nextIndex].id;
      }
      return prevId;
    });
  }, [formData]);

  const handleFieldChange = useCallback((fieldId, e) => {
    setFormValues(prev => ({ ...prev, [fieldId]: e.target.value }));
  }, []);

  const handleSubmit = useCallback(async (e) => {
    e.preventDefault();
    
    const currentIndex = formData.sections.findIndex(s => s.id === currentSectionId);
    
    // Allow navigation between sections even in preview mode
    if (currentIndex < formData.sections.length - 1) {
      handleSectionChange(1);
      return;
    }
    
    // Only prevent final submission in preview mode
    if (isPreview) {
      toast({ title: "Mode Preview", description: "Ini adalah mode preview. Form tidak akan benar-benar dikirim." });
      return;
    }
    
    if (selectedTier?.price === 0 && formData.upsellEnabled && !showUpsell) {
      setShowUpsell(true);
      return;
    }

    setIsSubmitting(true);
    
    try {
      // Skip API call for temp preview forms
      if (!formSlug.startsWith('temp_preview_')) {
        // Transform formValues to backend format: data[field_name]
        const dataPayload = {};
        
        // Add form responses in data[field_name] format
        Object.entries(formValues).forEach(([fieldId, value]) => {
          const field = formData.fields.find(f => f.id === fieldId);
          if (field) {
            dataPayload[field.label] = value;
          }
        });
        
        // Build the request payload
        const payload = {
          form_slug: formSlug,
          data: dataPayload
        };
        
        // Add optional fields
        if (selectedTier?.id) {
          payload.tier_id = selectedTier.id;
        }
        if (selectedTier?.name) {
          payload.tier_name = selectedTier.name;
        }
        if (selectedTier?.price !== undefined) {
          payload.amount = parseInt(selectedTier.price) || 0; // Pastikan integer murni
        }
        if (affiliateCode) {
          payload.affiliate_code = affiliateCode;
        }
        
        console.log('ï¿½ Selected Tier:', selectedTier);
        console.log('ï¿½ðŸ“¤ Sending payload:', payload);
        
        // Submit to API only for real forms (using slug)
        const response = await api.publicPost(`public/submissions`, payload);
        console.log('âœ… Response submitted to API via slug:', response);
      } else {
        console.log('ðŸ“‹ Preview mode - skipping API submission');
      }
      
      // Also save to localStorage as backup
      const localResponse = { 
        id: Date.now(), 
        submittedAt: new Date().toISOString(), 
        data: formValues, 
        tier: selectedTier?.name, 
        amount: selectedTier?.price || 0 
      };
      const savedResponses = JSON.parse(localStorage.getItem(`smartpath_responses_${formSlug}`) || '[]');
      savedResponses.push(localResponse);
      localStorage.setItem(`smartpath_responses_${formSlug}`, JSON.stringify(savedResponses));

      // Redirect ke halaman success dengan data
      const params = new URLSearchParams({
        form: formData.title,
        tier: selectedTier?.name || 'Gratis',
        timestamp: new Date().toLocaleString('id-ID')
      });
      
      navigate(`/success?${params.toString()}`);
    } catch (error) {
      console.error('Submit error:', error);
      toast({ 
        title: "Error! âŒ", 
        description: error.message || "Gagal mengirim form. Coba lagi.", 
        variant: "destructive" 
      });
    } finally {
      setIsSubmitting(false);
    }
  }, [isPreview, formData, currentSectionId, selectedTier, showUpsell, formValues, formSlug, navigate, toast, handleSectionChange]);

  // Memoize current section data
  const currentSectionData = useMemo(() => {
    if (!formData || !formData.sections) return null;
    const currentIndex = formData.sections.findIndex(s => s.id === currentSectionId);
    const currentSection = formData.sections[currentIndex];
    const isLastSection = currentIndex === formData.sections.length - 1;
    return { currentSection, currentIndex, isLastSection };
  }, [formData, currentSectionId]);

  // Memoize filtered fields for current section
  const currentSectionFields = useMemo(() => {
    if (!formData || !formData.fields || !currentSectionData?.currentSection) return [];
    return formData.fields.filter(f => f.sectionId === currentSectionData.currentSection.id);
  }, [formData, currentSectionData]);

  // Show expired preview message
  if (isExpiredPreview) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-yellow-50 flex items-center justify-center p-4">
        <motion.div 
          initial={{ opacity: 0, scale: 0.9 }} 
          animate={{ opacity: 1, scale: 1 }}
          className="bg-white rounded-2xl shadow-xl p-8 max-w-md text-center"
        >
          <div className="mb-4">
            <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Preview Sudah Kedaluwarsa</h2>
            <p className="text-gray-600 mb-4">
              Link preview ini sudah tidak berlaku. Preview form bersifat sementara dan otomatis dihapus setelah beberapa saat.
            </p>
            <div className="bg-blue-50 rounded-lg p-4 mb-6">
              <p className="text-sm text-blue-800">
                ðŸ’¡ <strong>Tips:</strong> Untuk melihat preview terbaru, silakan buka preview baru dari halaman Form Builder.
              </p>
            </div>
            <Button 
              onClick={() => window.close()} 
              className="w-full bg-gradient-to-r from-blue-600 to-blue-700"
            >
              Tutup Tab Ini
            </Button>
          </div>
        </motion.div>
      </div>
    );
  }

  // Skeleton Loading Component - Check loading BEFORE checking formData
  if (isLoading) {
    return (
      <div className={isPreview ? "" : "min-h-screen bg-gradient-to-br from-blue-50 via-white to-yellow-50"}>
        <div className={isPreview ? "" : "container mx-auto px-4 py-8 max-w-4xl"}>
          {/* Skeleton Header */}
          <div className="text-center mb-8 animate-pulse">
            <div className="h-16 w-16 bg-gray-200 rounded-full mx-auto mb-4"></div>
            <div className="h-8 bg-gray-200 rounded w-2/3 mx-auto mb-2"></div>
            <div className="h-4 bg-gray-100 rounded w-1/3 mx-auto"></div>
          </div>

          {/* Skeleton Form */}
          <div className="bg-white rounded-3xl shadow-xl p-6 md:p-8">
            <div className="space-y-8 animate-pulse">
              {/* Skeleton Section Header */}
              <div className="flex items-center gap-3 border-b pb-3">
                <div className="w-9 h-9 bg-blue-100 rounded-xl"></div>
                <div className="h-6 bg-gray-200 rounded w-1/4"></div>
              </div>

              {/* Skeleton Fields */}
              {[1, 2, 3].map(i => (
                <div key={i} className="space-y-2">
                  <div className="h-4 bg-gray-200 rounded w-1/5"></div>
                  <div className="h-10 bg-gray-100 rounded"></div>
                </div>
              ))}

              {/* Skeleton Buttons */}
              <div className="flex gap-4">
                <div className="h-14 bg-gray-200 rounded-xl flex-1"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (!formData) return <div className="text-center p-8 text-gray-500">Loading form...</div>;

  if (!currentSectionData) return <div className="text-center p-8 text-gray-500">Loading...</div>;

  const { currentSection, currentIndex, isLastSection } = currentSectionData;

  // Get icon component untuk current section
  const SectionIcon = SECTION_ICONS[currentSection?.icon] || FileText;

  return (
    <>
      {!isPreview && (
        <Helmet>
          <title>{formData.title} - SmartPath</title>
          <meta name="description" content="Daftar untuk mengikuti program SmartPath" />
        </Helmet>
      )}

      <div className={isPreview ? "" : "min-h-screen bg-gradient-to-br from-blue-50 via-white to-yellow-50"}>
        <div className={isPreview ? "" : "container mx-auto px-4 py-8 max-w-4xl"}>
          {/* Cover Image Banner with 4:1 Ratio */}
          {formData.coverImage && !isPreview && (
            <motion.div 
              initial={{ opacity: 0, scale: 0.95 }} 
              animate={{ opacity: 1, scale: 1 }}
              transition={{ duration: 0.5 }}
              className="relative w-full rounded-2xl overflow-hidden shadow-lg mb-8"
              style={{ aspectRatio: '4 / 1' }}
            >
              <img 
                src={formData.coverImage} 
                alt={`${formData.title} cover`}
                className="w-full h-full object-cover"
                onError={(e) => {
                  e.target.parentElement.style.display = 'none';
                }}
              />
              {/* Subtle gradient overlay */}
              <div className="absolute inset-0 bg-gradient-to-t from-black/10 via-transparent to-transparent"></div>
            </motion.div>
          )}
          
          <motion.div 
            initial={{ opacity: 0, y: -20 }} 
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="text-center mb-8"
          >
            <img 
              src="https://horizons-cdn.hostinger.com/97945fa6-ac93-416e-87c3-f12e19c0f260/0bed04b4c783f6129ca30c54d33467ad.png" 
              alt="SmartPath Logo" 
              className="h-16 w-auto mx-auto mb-4" 
            />
            <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-2">{formData.title || "Judul Form"}</h1>
            {formData.description && (
              <p className="text-gray-600 text-lg mb-2 max-w-2xl mx-auto">{formData.description}</p>
            )}
            <p className="text-gray-500 text-sm">Isi form di bawah untuk mendaftar</p>
          </motion.div>

          <AnimatePresence mode="wait">
            {!showUpsell ? (
              <motion.div key="main-form" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }} className="bg-white rounded-3xl shadow-xl p-6 md:p-8">
                <form onSubmit={handleSubmit} className="space-y-8">
                  <AnimatePresence mode="wait">
                    {currentSection && (
                      <motion.div key={currentSection.id} initial={{ opacity: 0, x: -30 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: 30 }} className="space-y-6">
                        <div className="flex items-center gap-3 border-b pb-3 mb-4">
                          <div className="p-2 bg-blue-100 rounded-xl">
                            <SectionIcon className="w-5 h-5 text-blue-600" />
                          </div>
                          <h2 className="text-xl font-bold text-gray-800">{currentSection.name}</h2>
                        </div>
                        {currentSectionFields.map((field) => (
                          <FormField
                            key={field.id}
                            field={field}
                            value={formValues[field.id]}
                            onChange={(e) => handleFieldChange(field.id, e)}
                          />
                        ))}
                        {isLastSection && formData.hasAffiliate && (
                          <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-200">
                            <Label htmlFor="affiliate-code" className="flex items-center gap-2 mb-2">
                              <Gift className="w-4 h-4 text-purple-600" />
                              <span className="text-purple-900 font-semibold">Kode Afiliasi (Opsional)</span>
                            </Label>
                            <Input
                              id="affiliate-code"
                              type="text"
                              placeholder="Masukkan kode afiliasi jika ada"
                              value={affiliateCode}
                              onChange={(e) => setAffiliateCode(e.target.value.toUpperCase())}
                              className="bg-white border-purple-300 focus:border-purple-500 focus:ring-purple-500"
                            />
                            <p className="text-xs text-purple-700 mt-2">Dapatkan benefit tambahan dengan kode afiliasi</p>
                          </div>
                        )}
                        {isLastSection && formData.hasPayment && (
                          <div>
                            <Label className="mb-3 block">Pilih Paket</Label>
                            <div className="grid md:grid-cols-3 gap-4">
                              {formData.pricingTiers.map((tier) => (
                                <motion.div key={tier.id} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} onClick={() => setSelectedTier(tier)} className={`p-4 rounded-2xl border-2 cursor-pointer transition-all ${selectedTier?.id === tier.id ? 'border-blue-600 bg-blue-50' : 'border-gray-200 hover:border-blue-300'}`}>
                                  <div className="text-center">
                                    <h3 className="font-bold text-gray-900 mb-2">{tier.name}</h3>
                                    <p className="text-2xl font-bold text-blue-600 mb-2">{tier.price === 0 ? 'Gratis' : `Rp ${formatRupiah(tier.price)}`}</p>
                                    <p className="text-sm text-gray-600">{tier.features}</p>
                                  </div>
                                </motion.div>
                              ))}
                            </div>
                          </div>
                        )}
                      </motion.div>
                    )}
                  </AnimatePresence>
                  <div className="flex gap-4">
                    {currentIndex > 0 && <Button type="button" variant="outline" onClick={() => handleSectionChange(-1)} className="w-full" disabled={isSubmitting}>Kembali</Button>}
                    <Button type="submit" disabled={isSubmitting || isLoading} className="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-lg py-6">
                      {isSubmitting ? 'Mengirim...' : (!isLastSection ? 'Lanjut' : (formData?.hasPayment ? (selectedTier?.price === 0 ? 'Daftar Gratis' : 'Lanjut ke Pembayaran') : 'Kirim Form'))}
                      <ArrowRight className="ml-2 w-5 h-5" />
                    </Button>
                  </div>
                </form>
              </motion.div>
            ) : (
              <motion.div 
                key="upsell" 
                initial={{ opacity: 0, y: 50 }} 
                animate={{ opacity: 1, y: 0 }} 
                exit={{ opacity: 0, y: -50 }}
                transition={{ duration: 0.5 }}
                className="relative overflow-hidden rounded-3xl"
              >
                {/* Animated Background */}
                <div className="absolute inset-0 bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 opacity-90" />
                <div className="absolute inset-0">
                  <div className="absolute top-0 -left-4 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob" />
                  <div className="absolute top-0 -right-4 w-72 h-72 bg-yellow-500 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-2000" />
                  <div className="absolute -bottom-8 left-20 w-72 h-72 bg-pink-500 rounded-full mix-blend-multiply filter blur-xl opacity-30 animate-blob animation-delay-4000" />
                </div>

                {/* Content */}
                <div className="relative bg-white/5 backdrop-blur-lg rounded-3xl shadow-2xl p-6 md:p-10 text-white border border-white/10">
                  {/* Header dengan animasi */}
                  <motion.div 
                    initial={{ scale: 0.8, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    transition={{ delay: 0.2, duration: 0.5 }}
                    className="text-center mb-8"
                  >
                    <motion.div
                      animate={{ 
                        rotate: [0, 10, -10, 10, 0],
                        scale: [1, 1.1, 1, 1.1, 1]
                      }}
                      transition={{ 
                        duration: 2,
                        repeat: Infinity,
                        repeatDelay: 1
                      }}
                      className="inline-block mb-4"
                    >
                      <div className="relative">
                        <Sparkles className="w-20 h-20 mx-auto text-yellow-300 drop-shadow-lg" />
                        <Crown className="w-8 h-8 absolute -top-2 -right-2 text-yellow-400 animate-bounce" />
                      </div>
                    </motion.div>
                    
                    <motion.h2 
                      initial={{ y: 20, opacity: 0 }}
                      animate={{ y: 0, opacity: 1 }}
                      transition={{ delay: 0.3 }}
                      className="text-3xl md:text-4xl font-extrabold mb-3 bg-gradient-to-r from-yellow-200 via-yellow-100 to-yellow-200 bg-clip-text text-transparent"
                    >
                      Tunggu Dulu! ðŸŽ‰
                    </motion.h2>
                    
                    <motion.div
                      initial={{ y: 20, opacity: 0 }}
                      animate={{ y: 0, opacity: 1 }}
                      transition={{ delay: 0.4 }}
                      className="inline-block bg-yellow-400/20 backdrop-blur-sm px-6 py-2 rounded-full border border-yellow-300/30 mb-3"
                    >
                      <p className="text-yellow-100 font-semibold flex items-center gap-2">
                        <Zap className="w-5 h-5 text-yellow-300" />
                        Penawaran Spesial Hanya Untuk Anda
                      </p>
                    </motion.div>
                    
                    <p className="text-blue-100 text-lg">
                      Upgrade sekarang dan dapatkan akses eksklusif dengan harga terbaik!
                    </p>
                  </motion.div>

                  {/* Pricing Cards */}
                  <div className="grid md:grid-cols-2 gap-6 mb-8">
                    {formData.pricingTiers.filter(t => t.price > 0).map((tier, index) => (
                      <motion.div
                        key={tier.id}
                        initial={{ opacity: 0, y: 50 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: 0.5 + (index * 0.1) }}
                        whileHover={{ scale: 1.05, y: -5 }}
                        className="relative group"
                      >
                        {/* Popular Badge */}
                        {index === 0 && (
                          <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 z-10">
                            <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-xs font-bold px-4 py-1 rounded-full shadow-lg flex items-center gap-1">
                              <Star className="w-3 h-3 fill-current" />
                              PALING POPULER
                            </div>
                          </div>
                        )}

                        <div className="bg-white/10 backdrop-blur-md rounded-3xl p-6 border-2 border-white/20 group-hover:border-yellow-300/50 transition-all duration-300 h-full flex flex-col">
                          <div className="flex items-center justify-between mb-4">
                            <h3 className="font-bold text-2xl">{tier.name}</h3>
                            <TrendingUp className="w-6 h-6 text-green-400" />
                          </div>
                          
                          <div className="mb-4">
                            <div className="flex items-baseline gap-2">
                              <span className="text-4xl font-extrabold text-yellow-300">
                                Rp {formatRupiah(tier.price)}
                              </span>
                            </div>
                            <p className="text-blue-200 text-sm mt-1">Pembayaran satu kali</p>
                          </div>

                          <div className="flex-1 mb-6">
                            <div className="space-y-3">
                              {tier.features.split(',').map((feature, idx) => (
                                <div key={idx} className="flex items-start gap-2">
                                  <CheckCircle2 className="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" />
                                  <span className="text-blue-50 text-sm">{feature.trim()}</span>
                                </div>
                              ))}
                            </div>
                          </div>

                          <Button 
                            onClick={() => { 
                              setSelectedTier(tier); 
                              handleSubmit({ preventDefault: () => {} }); 
                            }} 
                            className="w-full bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-gray-900 font-bold py-6 text-lg shadow-lg hover:shadow-xl transition-all duration-300 group-hover:scale-105"
                          >
                            <Award className="w-5 h-5 mr-2" />
                            Pilih Paket Ini
                            <ArrowRight className="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform" />
                          </Button>
                        </div>
                      </motion.div>
                    ))}
                  </div>

                  {/* Benefits Section */}
                  <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ delay: 0.8 }}
                    className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 mb-6 border border-white/10"
                  >
                    <h4 className="text-center font-semibold text-lg mb-4 text-yellow-200">
                      âš¡ Kenapa Upgrade Sekarang?
                    </h4>
                    <div className="grid md:grid-cols-3 gap-4 text-center">
                      <div>
                        <Zap className="w-8 h-8 mx-auto mb-2 text-yellow-300" />
                        <p className="text-sm text-blue-100">Akses Instan</p>
                      </div>
                      <div>
                        <Award className="w-8 h-8 mx-auto mb-2 text-yellow-300" />
                        <p className="text-sm text-blue-100">Konten Premium</p>
                      </div>
                      <div>
                        <TrendingUp className="w-8 h-8 mx-auto mb-2 text-yellow-300" />
                        <p className="text-sm text-blue-100">Update Lifetime</p>
                      </div>
                    </div>
                  </motion.div>

                  {/* Skip Button */}
                  <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ delay: 1 }}
                  >
                    <Button 
                      onClick={() => { 
                        setSelectedTier(formData.pricingTiers.find(t => t.price === 0)); 
                        handleSubmit({ preventDefault: () => {} }); 
                      }} 
                      variant="ghost" 
                      className="w-full bg-transparent border-2 border-white/30 text-white hover:bg-white/10 hover:border-white/50 transition-all duration-300"
                    >
                      Tidak, Lanjut dengan Paket Gratis
                    </Button>
                  </motion.div>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </div>
    </>
  );
};

export default UserFormView;
